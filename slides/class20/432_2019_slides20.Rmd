---
title: "432 Class 20 Slides"
author: "github.com/THOMASELOVE/2019-432"
date: "2019-04-11"
output:
  beamer_presentation: 
    colortheme: lily
    fonttheme: structurebold
    keep_tex: yes
    theme: Madrid
    fig_caption: FALSE
---

```{r set-options, echo=FALSE, cache=FALSE}
knitr::opts_chunk$set(comment=NA)
options(width = 60)
```

## Preliminaries

```{r packages, message=FALSE, warning=FALSE}
library(skimr)
library(rms)
library(survival)
library(OIsurv)
library(survminer)
library(broom)
library(tidyverse)
```

```{r data}
survex <- read.csv("data/survex.csv") %>% tbl_df
```

## Today's Agenda

- Regression on Time-to-event data
    - Cox Proportional Hazards Model

# Regression on Time-to-Event / Survival Outcomes

## The Cox Proportional Hazards Model: An Introduction

The Cox proportional hazards (Cox regression) model fits survival data with a constant (i.e. not varying over time) covariate $x$ to a hazard function of the form:

\[
h(t | x) = h_0(t) exp[\beta_1 x]
\]

where we will estimate the unknown value of $\beta_1$ and where $h_0(t)$ is the baseline hazard, which is a non-parametric and unspecified value which depends on $t$ but not on $x$.

## More on the Cox Model

- For particular $x$ values, we will be able to estimate the survival function if we have an estimate of the baseline survival function, $\hat{S_0}(t)$.

The estimated survival function for an individual with covariate value $x_k$ turns out to be

\[
\hat{S}(t | x_k) = [\hat{S_0}(t)]^{exp(\beta_1 x_k)}
\]

# Fitting the Cox Model with `coxph`

## Fitting a Cox Model in R

There are two main approaches to fitting Cox models in R.

- the `coxph` function in the `survival` package, and 
- the `cph` function in the `rms` package.

We'll start with the `coxph` approach, and fit a pair of models to the `survex` data.

## The `survex` data frame

The `survex.csv` file on the course website is essentially the same as a file simulated by Frank Harrell and his team\footnote{see the rms package documentation} to introduce some of the key results from the `cph` function, which is part of the `rms` package in R.

The `survex` data includes 1,000 subjects...

- `id` = patient ID (1-1000)
- `age` = patient's age at study entry, years
- `sex` = patient's sex (Male or Female)
- `study.yrs` = patient's years of observed time in study until death or censoring
- `death` = 1 if patient died, 0 if censored.

We'll start by creating a survival object, then fitting it using `sex` as a predictor.

## A Cox Model for the `survex` data using `sex`

```{r model1}
model1 <- with(survex, coxph(Surv(study.yrs, death) ~ sex))
model1
```

- This tiny summary provides an overall comparison of males to females, using a proportional hazards model.
    + The default R approach uses the "efron" method of breaking ties: other options include "breslow" and "exact".
    
## `summary(model1)`

![](figures/fig1.png)

## Interpreting the Hazard Ratio estimate

Our hazard ratio estimate is 0.54 for Males (compared to Females)

```
        exp(coef) exp(-coef) lower .95 upper .95
sexMale    0.5382      1.858    0.4027    0.7194
```
The hazard ratio is a multiplicative effect of the covariate (Male sex) on the hazard function for death.

- A hazard ratio of 1 indicates no effect
- A hazard ratio < 1 indicates a decrease in the hazard for Males as compared to Females
- A hazard ratio > 1 indicates an increase in the hazard for Males as compared to Females

## Likelihood Ratio Test in more detail via `anova`

```{r}
anova(model1)
```

## Model 2: `age` and `sex`

```{r model2}
(model2 <- with(survex,
    coxph(Surv(study.yrs, death) ~ age + sex)
))
```

## `summary(model2)`

![](figures/fig2.png)

## Interpreting the Hazard Ratio estimate

```
        exp(coef) exp(-coef) lower .95 upper .95
age        1.0428     0.9589    1.0315    1.0543
sexMale    0.5502     1.8176    0.4115    0.7356
```

- If Harry is one year older than Steve, and both are male, then Harry's hazard of death is 1.04 times that of Steve (95% CI 1.03, 1.05). Alternatively, Steve's Hazard is 0.96 times that of Harry.
- If Harry (male) and Sally (female) are the same age, then Harry's hazard of death is 0.55 times that of Sally (95% CI 0.41, 0.74). Alternatively, Sally's hazard is 1.82 times that of Harry.

## Concordance and R^2^ Summaries

```
Concordance= 0.688  (se = 0.023 )
Rsquare= 0.068   (max possible= 0.903 )
```

- Concordance is only appropriate when we have at least one continuous predictor in our Cox model, in which case it assesses the probability of agreement between the survival time and the risk score generated by the (continuous) predictor or set of predictors. A value of 1 indicates perfect agreement, 0.5 is no better than chance. Our concordance = 0.69, which is a fairly typical value.
- Rsquare here is Cox and Snell's pseudo-R^2^, which reflects the improvement of the model we have fit over the model with the intercept alone, as tested by the likelihood ratio test. 
    - The maximum value of this statistic is often less than one, in which case R will tell you that.

## Tidy the model's coefficients with `broom::tidy`

```{r}
tidy(model2)
```

## Glance at model summaries with `broom::glance`

```{r}
glance(model2)
```

## `anova(model2)` shows sequential LR tests

```{r, echo = FALSE}
anova(model2)
```

## Testing the Key Assumption: Proportional Hazards

```{r}
cox.zph(model2, transform = "km", global = TRUE)
```

The *p* values show whether the interaction between the specified covariate and time is significant. 

- A significant effect here is an indication of trouble with the PH assumption.

## Plotting the `cox.zph` results

```{r, echo = FALSE}
par(mfrow = c(1,2))
plot(cox.zph(model2, transform = "km", global = TRUE))
par(mfrow = c(1,1))
```

## Plotting the `cox.zph` results (code)

```{r, eval = FALSE}
par(mfrow = c(1,2))
plot(cox.zph(model2, transform = "km", global = TRUE))
par(mfrow = c(1,1))
```

- If the proportional hazards assumption is appropriate, then we should see a slope of essentially zero in each such plot. 
- A slope that is seriously different from zero suggests a violation of the proportional hazards assumption.
- Here, we may have an issue with the assumption of PH in `sex`. 
    - If we did, we'd either add a non-linear term (if `sex` was continuous), or use a different kind of survival model.

# Building a Cox Model with `cph` from the `rms` package

## Building `model2` using the `cph` function

```{r}
d <- datadist(survex)
options(datadist="d")

S <- Surv(time = survex$study.yrs, event = survex$death)

mod2 <- cph(S ~ age + sex, 
            data = survex, 
            x = TRUE, y = TRUE, surv = TRUE)
```

## Looking at `mod2`

```{r, echo = FALSE}
mod2
```

## Validation of `mod2` Summaries

```{r}
set.seed(432109); validate(mod2)
```

## ANOVA on `mod2`

```{r}
anova(mod2)
```

## Effect Sizes via `cph` for `mod2`

```{r}
summary(mod2)
```

## `plot(summary(mod2))`

```{r, fig.height = 4, echo = FALSE}
plot(summary(mod2))
```

## Comparing Survival for males in `mod2` at various ages

```{r, echo = FALSE}
survplot(mod2, age = c(20, 40, 50, 60, 80), 
         time.inc=2, 
         type="kaplan-meier", 
         xlab="Study Survival Time in Years")
```

## Code for prior slide

```{r, eval = FALSE}
survplot(mod2, age = c(20, 40, 50, 60, 80), 
         time.inc=2, 
         type="kaplan-meier", 
         xlab="Study Survival Time in Years")
```


## Comparing Survival by sex in `mod2` at median age (49)

```{r, echo = FALSE}
survplot(mod2, sex = c("Male", "Female"), 
         time.inc=2, 
         conf.int = TRUE,
         col = c("blue","red"),
         col.fill = c("lightblue", "pink"),
         type="kaplan-meier", 
         xlab="Study Survival Time in Years")
```

## Code for prior slide

```{r, eval = FALSE}
survplot(mod2, sex = c("Male", "Female"), 
         time.inc=2, 
         conf.int = TRUE,
         col = c("blue","red"),
         col.fill = c("lightblue", "pink"),
         type="kaplan-meier", 
         xlab="Study Survival Time in Years")
```

## Plotting the `age` effect implied by `mod2`

```{r}
ggplot(Predict(mod2, age))
```

## Plotting the `sex` effect implied by `mod2`

```{r}
ggplot(Predict(mod2, sex))
```

## `mod2` Nomogram (code)

```{r, eval = FALSE}
sv <- Survival(mod2)
surv2 <- function(x) sv(2, lp = x)
surv5 <- function(x) sv(5, lp = x)

plot(nomogram(mod2,
              fun = list(surv2, surv5),
              funlabel = c("2 year survival",
                  "5 year survival")))
```

## Resulting `mod2` Nomogram

```{r, echo = FALSE}
sv <- Survival(mod2)
surv2 <- function(x) sv(2, lp = x)
surv5 <- function(x) sv(5, lp = x)

plot(nomogram(mod2,
              fun = list(surv2, surv5),
              funlabel = c("2 year survival",
                  "5 year survival")))
```

## Model 3, with a spline in age and age-sex interaction

```{r}
d <- datadist(survex)
options(datadist="d")

S <- Surv(time = survex$study.yrs, event = survex$death)

mod3 <- cph(S ~ rcs(age,4) + catg(sex) + age %ia% sex, 
            data = survex, 
            x = TRUE, y = TRUE, surv = TRUE)
```

## Looking at `mod3`

![](figures/fig3.png)

## Validate summary statistics in `mod3`

```{r}
set.seed(432301); validate(mod3)
```

## `summary(mod3)`

```{r, echo = FALSE}
summary(mod3)
```

## `plot(summary(mod3))`

```{r, fig.height = 4, echo = FALSE}
plot(summary(mod3))
```

## Comparing Survival for males in `mod3` at various ages

```{r, echo = FALSE}
survplot(mod3, age = c(20, 40, 50, 60, 80), 
         time.inc=2, 
         type="kaplan-meier", 
         xlab="Study Survival Time in Years")
```

## Comparing Survival by sex in `mod3` at median age (49)

```{r, echo = FALSE}
survplot(mod3, sex = c("Male", "Female"), 
         time.inc=2, 
         conf.int = TRUE,
         col = c("blue","red"),
         col.fill = c("lightblue", "pink"),
         type="kaplan-meier", 
         xlab="Study Survival Time in Years")
```

## Plotting the `age` effect implied by `mod2`

```{r}
ggplot(Predict(mod3, age))
```

## Plotting the `sex` effect implied by `mod2`

```{r}
ggplot(Predict(mod3, sex))
```

## `mod3` Nomogram 

```{r, echo = FALSE}
sv <- Survival(mod3)
surv2 <- function(x) sv(2, lp = x)
surv5 <- function(x) sv(5, lp = x)

plot(nomogram(mod3,
              fun = list(surv2, surv5),
              funlabel = c("2 year survival",
                  "5 year survival")))
```

## Checking the Proportional Hazards Assumption

```{r}
cox.zph(mod3, transform = "km", global = TRUE)
```

## Plots for PH Assumption

```{r, echo = FALSE}
par(mfrow = c(2,3))
plot(cox.zph(mod3, transform = "km", global = TRUE))
```

## Next Time

One more survival analysis example
